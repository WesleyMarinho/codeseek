<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - DigiServer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/public/css/core.css">
</head>
<body class="h-full">
    <div id="notification-container"></div>

    <div class="flex h-full">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-800 text-white flex flex-col">
            <div class="text-2xl font-bold p-5 bg-gray-900">DigiServer Admin</div>
            <nav class="flex-1 p-4">
                <ul>
                    <li class="mb-2"><a href="/admin" class="flex items-center p-3 bg-gray-700 rounded-md text-white font-semibold"><i class="fas fa-tachometer-alt mr-3"></i>Dashboard</a></li>
                    <li class="mb-2"><a href="/admin/users" class="flex items-center p-3 hover:bg-gray-700 rounded-md"><i class="fas fa-users mr-3"></i>Users</a></li>
                    <li class="mb-2"><a href="/admin/products" class="flex items-center p-3 hover:bg-gray-700 rounded-md"><i class="fas fa-boxes mr-3"></i>Products</a></li>
                    <li class="mb-2"><a href="/admin/categories" class="flex items-center p-3 hover:bg-gray-700 rounded-md"><i class="fas fa-tags mr-3"></i>Categories</a></li>
                    <li class="mb-2"><a href="/admin/subscriptions" class="flex items-center p-3 hover:bg-gray-700 rounded-md"><i class="fas fa-sync-alt mr-3"></i>Subscriptions</a></li>
                    <li class="mb-2"><a href="/admin/licenses" class="flex items-center p-3 hover:bg-gray-700 rounded-md"><i class="fas fa-key mr-3"></i>Licenses</a></li>
                    <li class="mb-2"><a href="/admin/webhooks" class="flex items-center p-3 hover:bg-gray-700 rounded-md"><i class="fas fa-bolt mr-3"></i>Webhooks</a></li>
                    <li class="mb-2"><a href="/admin/settings" class="flex items-center p-3 hover:bg-gray-700 rounded-md"><i class="fas fa-cog mr-3"></i>Settings</a></li>
                </ul>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <a href="#" id="logout-button" class="flex items-center p-3 hover:bg-gray-700 rounded-md"><i class="fas fa-sign-out-alt mr-3"></i>Logout</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-auto">
            <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Admin Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <span id="user-greeting" class="font-semibold text-gray-600">Admin</span>
                        <img src="https://picsum.photos/seed/admin_avatar/40/40" alt="Avatar" class="w-10 h-10 rounded-full border-2 border-blue-500">
                    </div>
                </div>
            </header>

            <div class="p-6">
                <!-- KPIs -->
                <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex items-center">
                        <div class="bg-blue-100 text-blue-600 w-16 h-16 rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-dollar-sign text-3xl"></i>
                        </div>
                        <div>
                            <h4 class="text-gray-500 font-semibold">MRR</h4>
                            <p id="kpi-mrr" class="text-3xl font-bold text-gray-900 mt-1">$0.00</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex items-center">
                        <div class="bg-green-100 text-green-600 w-16 h-16 rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-sync-alt text-3xl"></i>
                        </div>
                        <div>
                            <h4 class="text-gray-500 font-semibold">Active Subscriptions</h4>
                            <p id="kpi-subscriptions" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex items-center">
                        <div class="bg-purple-100 text-purple-600 w-16 h-16 rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                            <i class="fas fa-users text-3xl"></i>
                        </div>
                        <div>
                            <h4 class="text-gray-500 font-semibold">New Users (Month)</h4>
                            <p id="kpi-new-users" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                        </div>
                    </div>
                </section>

                <!-- Recent Sales -->
                <section class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b">
                        <h2 class="text-xl font-bold text-gray-800">Recent Sales</h2>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Invoice ID</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">User</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Plan</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Amount</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="sales-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Dados serÃ£o inseridos aqui pelo JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="/public/js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const profileRes = await fetch('/api/user/profile', { credentials: 'include' });
                if (profileRes.ok) {
                    const profileData = await profileRes.json();
                    document.getElementById('user-greeting').textContent = `Hello, ${profileData.user.username}!`;
                }
            } catch (e) { console.error('Failed to fetch profile'); }

            await loadAdminDashboardData();
        });

        function formatCurrency(amount) {
            return `$${parseFloat(amount || 0).toFixed(2)}`;
        }

        async function loadAdminDashboardData() {
            const kpiMrr = document.getElementById('kpi-mrr');
            const kpiSubscriptions = document.getElementById('kpi-subscriptions');
            const kpiNewUsers = document.getElementById('kpi-new-users');
            const salesTbody = document.getElementById('sales-table-body');
            
            try {
                const response = await fetch('/api/admin/dashboard-stats', { credentials: 'include' });
                if (!response.ok) {
                    if (response.status === 403) alert('Access Denied. You must be an administrator.');
                    throw new Error('Failed to load dashboard data');
                }
                const { success, stats, recentSales } = await response.json();

                if (success) {
                    // Preenche os KPIs
                    kpiMrr.textContent = formatCurrency(stats.mrr);
                    kpiSubscriptions.textContent = stats.activeSubscriptions;
                    kpiNewUsers.textContent = stats.newUsers;

                    // Preenche a tabela de vendas recentes
                    salesTbody.innerHTML = '';
                    if (recentSales && recentSales.length > 0) {
                        recentSales.forEach(sale => {
                            const statusBadge = `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>Completed</span>`;
                            const planName = sale.subscription ? `Subscription (${sale.subscription.plan})` : 'Individual Product';

                            const row = `
                                <tr class="hover:bg-gray-50 transition duration-150">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.invoiceNumber}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${sale.user ? sale.user.email : 'N/A'}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${planName}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${formatCurrency(sale.amount)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                                </tr>`;
                            salesTbody.insertAdjacentHTML('beforeend', row);
                        });
                    } else {
                        salesTbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No recent sales found.</td></tr>`;
                    }
                }
            } catch (error) {
                console.error('Error loading admin dashboard data:', error);
                document.querySelector('.dashboard-content').innerHTML = '<p class="text-center text-red-500">Error: Could not load dashboard data.</p>';
            }
        }
        </script>
            </div>
        </main>
    </div>
</body>
</html>
</html>